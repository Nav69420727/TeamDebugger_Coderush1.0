<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AuraScan AI - Premium Skin Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f7f9fc;
            --main-gradient-start: #008080;
            --main-gradient-end: #006a6a;
            --secondary-color: #1a202c;
            --text-color: #5a6474;
            --card-bg: #ffffff;
            --border-color: #e2e8f0;
            --aurora-bg: #edf7f6;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--secondary-color);
        }
        
        .title-font { font-family: 'Playfair Display', serif; }
        .text-main { color: var(--main-gradient-start); }
        .text-secondary { color: var(--secondary-color); }
        .text-muted { color: var(--text-color); }

        .primary-button {
            background-image: linear-gradient(to right, var(--main-gradient-start), var(--main-gradient-end));
            color: #ffffff;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px 0 rgba(0, 128, 128, 0.25);
        }
        .primary-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 20px 0 rgba(0, 128, 128, 0.35);
        }
        .primary-button:disabled {
            background: #cbd5e1;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Step Transitions & Content Animation */
        .step-content { transition: opacity 0.3s ease-out, transform 0.3s ease-out; }
        .step-content.hidden { opacity: 0; transform: translateY(20px); pointer-events: none; position: absolute; width: calc(100% - 4rem); }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-in > * { animation: fadeInUp 0.5s ease-out both; }
        .animate-in > *:nth-child(1) { animation-delay: 0.1s; }
        .animate-in > *:nth-child(2) { animation-delay: 0.2s; }
        .animate-in > *:nth-child(3) { animation-delay: 0.3s; }
        .animate-in > *:nth-child(4) { animation-delay: 0.4s; }
        .animate-in > *:nth-child(5) { animation-delay: 0.5s; }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: var(--main-gradient-start); }

        /* Pane Styling with Aurora Effect */
        .right-pane {
            background-color: var(--aurora-bg);
            position: relative;
            overflow: hidden;
        }
        .right-pane::before {
            content: '';
            position: absolute;
            top: -20%; right: -20%;
            width: 60%; height: 60%;
            background-image: radial-gradient(circle, rgba(0, 128, 128, 0.15), transparent 60%);
            animation: aurora-pulse 15s infinite ease-in-out;
        }
        @keyframes aurora-pulse {
            0%, 100% { transform: scale(1) rotate(0deg); opacity: 0.8; }
            50% { transform: scale(1.2) rotate(15deg); opacity: 1; }
        }

        /* Loading Animation */
        @keyframes pulse-dot {
            0%, 100% { transform: scale(0.9); box-shadow: 0 0 0 0 rgba(0, 128, 128, 0.7); }
            50% { transform: scale(1); box-shadow: 0 0 0 12px rgba(0, 128, 128, 0); }
        }
        .pulse-dot { animation: pulse-dot 2.5s infinite; }

        /* Custom Checkbox Animation */
        .custom-checkbox input:checked + svg { transform: scale(1); }
        .custom-checkbox svg { transition: transform 0.2s ease; transform: scale(0); }
        
        /* Tab Styling with Sliding Indicator */
        .tabs-container { position: relative; }
        #tab-indicator {
            position: absolute;
            bottom: 0;
            height: 2px;
            background-color: var(--main-gradient-start);
            transition: left 0.3s cubic-bezier(0.25, 0.8, 0.25, 1), width 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        .tab-btn.active { color: var(--main-gradient-start); }
        .tab-panel.hidden { display: none; }
        
        /* Stepper UI */
        #stepper-nav { transition: all 0.4s ease; }
        .step-indicator { transition: all 0.4s ease; }
        .step-indicator.completed, .step-indicator.active {
            background-color: var(--main-gradient-start);
            color: white;
        }
        #progress-bar { transition: width 0.4s ease; }
    </style>
</head>
<body class="w-full h-screen overflow-hidden antialiased">

    <div class="flex h-full bg-white shadow-2xl rounded-2xl m-4">
        <div class="w-full lg:w-1/2 h-full p-8 flex flex-col">
            <header class="mb-6">
                <h1 class="title-font text-4xl font-bold text-main">AuraScan AI</h1>
                <p class="text-muted">Reimagined Skin Analysis</p>
            </header>
            
            <div id="stepper-nav" class="mb-8 w-full">
                <div class="flex items-center">
                    <div class="step-indicator w-8 h-8 flex items-center justify-center rounded-full bg-gray-200 text-gray-500 font-bold" data-step="1">1</div>
                    <div class="flex-auto border-t-2 border-gray-200 mx-2 relative">
                         <div id="progress-bar" class="absolute top-0 left-0 h-full bg-main" style="width: 0%;"></div>
                    </div>
                    <div class="step-indicator w-8 h-8 flex items-center justify-center rounded-full bg-gray-200 text-gray-500 font-bold" data-step="2">2</div>
                    <div class="flex-auto border-t-2 border-gray-200 mx-2"></div>
                    <div class="step-indicator w-8 h-8 flex items-center justify-center rounded-full bg-gray-200 text-gray-500 font-bold" data-step="3">3</div>
                </div>
            </div>

            <main class="flex-grow overflow-y-auto custom-scrollbar pr-4 -mr-4">
                <div id="stepper-ui" class="relative">
                    <div id="step-upload" class="step-content"></div>
                    <div id="step-questions" class="step-content hidden"></div>
                    <div id="step-results" class="step-content hidden"></div>
                </div>
            </main>
        </div>

        <div class="hidden lg:flex w-1/2 h-full items-center justify-center p-8 right-pane rounded-r-2xl">
            <div id="visual-pane-content" class="text-center transition-opacity duration-500 ease-in-out">
                
                <div id="visual-initial">
                    <div class="w-32 h-32 mx-auto bg-white/50 backdrop-blur-sm rounded-full flex items-center justify-center shadow-lg">
                        <svg class="h-16 w-16 text-main" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd" /></svg>
                    </div>
                    <h3 class="mt-6 text-2xl font-semibold text-secondary">Ready for Your Analysis</h3>
                    <p class="text-muted mt-2 max-w-sm mx-auto">Upload an image to begin the AI-powered skin analysis process.</p>
                </div>

                <div id="visual-image-preview" class="hidden">
                    <h3 class="text-2xl font-semibold text-secondary mb-4">Confirm Your Image</h3>
                    <img id="right-pane-image" src="" class="max-w-xs mx-auto max-h-72 rounded-xl shadow-2xl object-cover">
                    <p class="text-muted mt-4 max-w-sm mx-auto">Please answer a few questions to refine the analysis.</p>
                </div>

                <div id="visual-loading" class="hidden">
                    <div class="relative w-24 h-24 mx-auto">
                        <div class="absolute inset-0 border-2 border-gray-300 rounded-full"></div>
                        <div class="absolute inset-0 border-2 border-t-main rounded-full animate-spin"></div>
                        <div class="absolute inset-2 bg-main rounded-full pulse-dot"></div>
                    </div>
                    <h3 class="mt-6 text-2xl font-semibold text-secondary">Analyzing...</h3>
                    <p id="loading-text" class="text-muted mt-2 max-w-sm mx-auto h-5">Our AI is examining your image.</p>
                </div>

                <div id="visual-error" class="hidden">
                    <svg class="mx-auto h-24 w-24 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    <h3 id="error-title" class="mt-4 text-2xl font-semibold text-red-800">Analysis Failed</h3>
                    <p id="error-message" class="text-red-600 mt-2 max-w-sm mx-auto">An unexpected error occurred.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM Elements ---
        const steps = { upload: document.getElementById('step-upload'), questions: document.getElementById('step-questions'), results: document.getElementById('step-results') };
        const visuals = { initial: document.getElementById('visual-initial'), imagePreview: document.getElementById('visual-image-preview'), loading: document.getElementById('visual-loading'), error: document.getElementById('visual-error') };
        const stepperIndicators = document.querySelectorAll('.step-indicator');
        const progressBar = document.getElementById('progress-bar');
        
        // --- State ---
        let base64Image = null;
        let userAnswers = {};
        let currentStep = 'upload';
        let loadingTextInterval;

        // --- Functions ---
        function switchStep(targetStep) {
            steps[currentStep].classList.add('hidden');
            steps[targetStep].classList.remove('hidden');
            currentStep = targetStep;
            updateStepperUI();
        }

        function switchVisual(targetVisual, imageUrl = null) {
            Object.values(visuals).forEach(v => v.classList.add('hidden'));
            if (visuals[targetVisual]) {
                visuals[targetVisual].classList.remove('hidden');
                if (targetVisual === 'imagePreview' && imageUrl) {
                    document.getElementById('right-pane-image').src = imageUrl;
                }
            }
        }
        
        function updateStepperUI() {
            let stepNumber = 1;
            if(currentStep === 'questions') stepNumber = 2;
            if(currentStep === 'results') stepNumber = 3;

            stepperIndicators.forEach(ind => {
                const indStep = parseInt(ind.dataset.step);
                ind.classList.remove('active', 'completed');
                if (indStep < stepNumber) ind.classList.add('completed');
                else if (indStep === stepNumber) ind.classList.add('active');
            });
            
            progressBar.style.width = `${((stepNumber - 1) / 2) * 50}%`;
        }

        function handleFileSelect(file) {
            if (!file || !file.type.startsWith('image/')) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                renderUploadStep(e.target.result, true);
                base64Image = e.target.result.split(',')[1];
            };
            reader.readAsDataURL(file);
        }

        function setupQuestions() {
            steps.questions.innerHTML = `
                <div class="animate-in">
                    <h2 class="text-2xl font-bold mb-2">Provide More Context</h2>
                    <p class="text-muted mb-6">Your answers help the AI achieve higher accuracy.</p>
                    <div class="space-y-6">
                        <div>
                            <label class="font-semibold text-secondary">How long has this condition been present?</label>
                            <input type="text" id="q-duration" placeholder="e.g., 2 weeks, a few months" class="w-full mt-2 bg-card-bg p-3 rounded-lg border-2 border-border-color focus:border-main outline-none transition">
                        </div>
                        <div>
                            <label class="font-semibold text-secondary">How does it feel? (Select all that apply)</label>
                            <div class="mt-2 grid grid-cols-2 gap-3">
                                ${createCheckbox('sensation', 'Itchy')}
                                ${createCheckbox('sensation', 'Painful')}
                                ${createCheckbox('sensation', 'Burning')}
                                ${createCheckbox('sensation', 'Numb')}
                            </div>
                        </div>
                        <div>
                            <label class="font-semibold text-secondary">Has it changed recently?</label>
                            <div class="mt-2 grid grid-cols-2 gap-3">
                                ${createCheckbox('progression', 'Grown in size')}
                                ${createCheckbox('progression', 'Changed shape')}
                                ${createCheckbox('progression', 'Changed color')}
                                ${createCheckbox('progression', 'No change')}
                            </div>
                        </div>
                    </div>
                    <button id="analyze-button" class="w-full mt-8 primary-button font-bold py-3 px-4 rounded-lg">Begin AI Analysis</button>
                </div>
            `;
            steps.questions.querySelector('#analyze-button').addEventListener('click', handleAnalysis);
        }

        function createCheckbox(name, value) {
            const id = `${name}-${value.replace(/\s+/g, '-')}`;
            return `
                <label for="${id}" class="custom-checkbox flex items-center p-3 bg-card-bg rounded-lg cursor-pointer hover:bg-gray-50 border-2 border-border-color has-[:checked]:border-main transition has-[:checked]:bg-teal-50">
                    <input type="checkbox" name="${name}" id="${id}" value="${value}" class="sr-only">
                    <span class="w-5 h-5 flex items-center justify-center border-2 border-gray-300 rounded-sm mr-3 transition">
                        <svg class="w-3 h-3 text-white fill-current" viewBox="0 0 12 12"><path d="M4.293 8.293l-2-2a1 1 0 011.414-1.414L5 6.172l3.293-3.293a1 1 0 011.414 1.414l-4 4a1 1 0 01-1.414 0z" fill="var(--main-gradient-start)"/></svg>
                    </span>
                    <span class="text-secondary text-sm">${value}</span>
                </label>
            `;
        }

        async function handleAnalysis() {
            userAnswers.duration = document.getElementById('q-duration').value;
            userAnswers.sensation = Array.from(document.querySelectorAll('input[name="sensation"]:checked')).map(el => el.value);
            userAnswers.progression = Array.from(document.querySelectorAll('input[name="progression"]:checked')).map(el => el.value);
            
            if (!base64Image) return;
            switchStep('results');
            steps.results.innerHTML = ''; // Clear previous results
            switchVisual('loading');

            const loadingTexts = ["Analyzing pixels...", "Identifying patterns...", "Consulting dermatological data...", "Cross-referencing symptoms...", "Finalizing assessment..."];
            let textIndex = 0;
            const loadingTextElement = document.getElementById('loading-text');
            loadingTextElement.textContent = loadingTexts[textIndex];
            loadingTextInterval = setInterval(() => {
                textIndex = (textIndex + 1) % loadingTexts.length;
                loadingTextElement.textContent = loadingTexts[textIndex];
            }, 2000);
            
            await callGeminiAPI();
        }

        async function callGeminiAPI() {
            clearInterval(loadingTextInterval);
            const apiKey = "AIzaSyD1sg3Pz5CzGkIyWegHwaiAHc5TN4wt3gw"; // IMPORTANT: API key has been added
            if (!apiKey) {
                displayError("API Key is missing. Please add it to the script.");
                return;
            }
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;

            const prompt = `You are a dermatology AI assistant. Analyze the skin condition image and user's answers. IMPORTANT: Your purpose is to provide potential conditions for informational purposes ONLY, NOT to provide a medical diagnosis. Always include a clear disclaimer that the user must consult a qualified healthcare professional.
            User's Answers:
            - Duration: ${userAnswers.duration || 'Not specified'}
            - Sensation: ${userAnswers.sensation.join(', ') || 'Not specified'}
            - Progression: ${userAnswers.progression.join(', ') || 'Not specified'}
            
            Based on ALL data, identify up to 3 likely conditions. For each, provide: name, description, a confidence score (0-100), a brief reasoning, common symptoms, precautions, "what to do", and "what to avoid". Respond ONLY in the specified JSON format.`;

            const payload = {
                contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/jpeg", data: base64Image } }] }],
                generationConfig: { responseMimeType: "application/json", responseSchema: { type: "OBJECT", properties: { disclaimer: { type: "STRING" }, diseases: { type: "ARRAY", items: { type: "OBJECT", properties: { name: { type: "STRING" }, description: { type: "STRING" }, confidenceScore: { type: "NUMBER" }, reasoning: { type: "STRING" }, symptoms: { type: "ARRAY", items: { type: "STRING" } }, precautions: { type: "ARRAY", items: { "type": "STRING" } }, whatToDo: { type: "ARRAY", items: { "type": "STRING" } }, whatToAvoid: { type: "ARRAY", items: { "type": "STRING" } } }, required: ["name", "description", "confidenceScore", "reasoning", "symptoms", "precautions", "whatToDo", "whatToAvoid"] } } }, required: ["disclaimer", "diseases"] } }
            };

            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API Error: ${response.statusText} (${response.status})`);
                const result = await response.json();
                
                if (result.candidates && result.candidates[0].content.parts[0].text) {
                    const jsonText = result.candidates[0].content.parts[0].text;
                    const apiResponseData = JSON.parse(jsonText);
                    renderFinalResult(apiResponseData);
                } else {
                    throw new Error("Invalid API response structure. The model may have been blocked or returned an empty response.");
                }
            } catch (error) {
                console.error("API Error:", error);
                displayError(error.message);
            }
        }

        function animateCountUp(element, finalValue) {
            let start = 0;
            const duration = 1500;
            const stepTime = Math.abs(Math.floor(duration / finalValue));
            const timer = setInterval(() => {
                start += 1;
                element.textContent = `${start}%`;
                if (start === finalValue) {
                    clearInterval(timer);
                }
            }, stepTime);
        }

        function renderFinalResult(data) {
            switchVisual('initial');
            const topCondition = data.diseases.sort((a,b) => b.confidenceScore - a.confidenceScore)[0];
            
            steps.results.innerHTML = `
                <div class="animate-in">
                    <div class="flex justify-between items-center">
                        <div>
                            <h2 class="text-2xl font-bold">Analysis Complete</h2>
                            <p class="text-muted">Based on our analysis, here is the most likely condition.</p>
                        </div>
                        <div class="text-right">
                            <div id="confidence-score" class="text-3xl font-bold text-main">0%</div>
                            <div class="text-sm text-muted">Confidence</div>
                        </div>
                    </div>

                    <div class="mt-6 bg-card-bg p-6 rounded-xl border border-border-color">
                        <h3 class="text-xl font-bold text-main">${topCondition.name}</h3>
                        <p class="mt-2 text-secondary">${topCondition.description}</p>
                    </div>

                    <div class="mt-6">
                        <div class="tabs-container flex border-b border-border-color">
                            <button class="tab-btn active py-2 px-4 text-sm font-semibold" data-tab="recommendations">Recommendations</button>
                            <button class="tab-btn py-2 px-4 text-sm font-semibold" data-tab="reasoning">AI Reasoning</button>
                            <div id="tab-indicator"></div>
                        </div>
                        <div class="py-4">
                            <div id="tab-recommendations" class="tab-panel space-y-4">
                                ${createGuidanceList('What to Do', topCondition.whatToDo, 'check')}
                                ${createGuidanceList('What to Avoid', topCondition.whatToAvoid, 'x')}
                            </div>
                            <div id="tab-reasoning" class="tab-panel hidden">
                                <p class="text-muted text-sm leading-relaxed">${topCondition.reasoning}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4 p-4 bg-yellow-50 text-yellow-800 border-l-4 border-yellow-400 rounded-lg">
                        <h4 class="font-bold">Important Disclaimer</h4>
                        <p class="text-sm mt-1">${data.disclaimer}</p>
                    </div>
                    
                    <button id="reset-btn" class="w-full border-2 border-gray-300 text-text-color hover:bg-gray-100 font-bold py-3 px-4 rounded-lg mt-6 transition-colors">Start New Analysis</button>
                </div>
            `;
            
            const confidenceScoreEl = steps.results.querySelector('#confidence-score');
            animateCountUp(confidenceScoreEl, topCondition.confidenceScore);

            setupTabs();
            steps.results.querySelector('#reset-btn').addEventListener('click', resetApp);
        }

        function setupTabs() {
            const tabContainer = steps.results.querySelector('.tabs-container');
            const tabButtons = steps.results.querySelectorAll('.tab-btn');
            const tabIndicator = steps.results.querySelector('#tab-indicator');
            const tabPanels = steps.results.querySelectorAll('.tab-panel');

            function updateIndicator(el) {
                tabIndicator.style.left = `${el.offsetLeft}px`;
                tabIndicator.style.width = `${el.offsetWidth}px`;
            }
            updateIndicator(tabButtons[0]);

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    updateIndicator(button);
                    const targetTab = button.dataset.tab;
                    tabPanels.forEach(panel => {
                        panel.id === `tab-${targetTab}` ? panel.classList.remove('hidden') : panel.classList.add('hidden');
                    });
                });
            });
        }

        function createGuidanceList(title, items, iconType) {
            const icons = {
                check: `<svg class="h-5 w-5 text-green-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>`,
                x: `<svg class="h-5 w-5 text-red-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>`,
            };
            return `
                <div>
                    <h4 class="font-semibold text-secondary mb-2">${title}</h4>
                    <ul class="space-y-2">
                        ${items.map(item => `
                            <li class="flex items-start">
                                <span class="flex-shrink-0 mt-0.5 mr-3">${icons[iconType]}</span>
                                <span class="text-muted text-sm">${item}</span>
                            </li>`).join('')}
                    </ul>
                </div>
            `;
        }

        function displayError(message) {
            clearInterval(loadingTextInterval);
            switchVisual('error');
            document.getElementById('error-message').textContent = message;
            steps.results.innerHTML = `<button id="reset-btn" class="w-full border-2 border-gray-300 text-text-color hover:bg-gray-100 font-bold py-3 px-4 rounded-lg mt-4 transition-colors">Try Again</button>`;
            steps.results.querySelector('#reset-btn').addEventListener('click', resetApp);
        }

        function resetApp() {
            base64Image = null;
            userAnswers = {};
            renderUploadStep('', false);
            switchStep('upload');
            switchVisual('initial');
        }

        function renderUploadStep(imageSrc = '', isFileSelected = false) {
             steps.upload.innerHTML = `
                <div class="animate-in">
                    <h2 class="text-2xl font-bold mb-2">Upload Your Image</h2>
                    <p class="text-muted mb-6">For an accurate analysis, please use a clear, well-lit photo of the area of concern.</p>
                    <div id="image-drop-zone" class="border-2 border-dashed border-gray-300 rounded-xl p-6 text-center cursor-pointer hover:border-main transition-colors bg-white">
                        <img id="image-preview" src="${imageSrc}" class="${isFileSelected ? '' : 'hidden'} max-w-full mx-auto max-h-48 rounded-lg mb-4">
                        <div id="upload-prompt" class="${isFileSelected ? 'hidden' : ''}">
                            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" /></svg>
                            <p class="mt-2 text-secondary">Drag & drop or <span class="text-main font-semibold">click to upload</span></p>
                            <p class="text-xs text-muted mt-1">PNG, JPG, or JPEG</p>
                        </div>
                    </div>
                    <input type="file" id="image-uploader" class="hidden" accept="image/*">
                    <button id="next-to-questions-btn" class="w-full primary-button font-bold py-3 px-4 rounded-lg mt-6" ${isFileSelected ? '' : 'disabled'}>Continue</button>
                </div>
            `;

            // Re-bind event listeners for the newly created elements
            const imageDropZone = steps.upload.querySelector('#image-drop-zone');
            const imageUploader = steps.upload.querySelector('#image-uploader');
            imageDropZone.addEventListener('click', () => imageUploader.click());
            imageUploader.addEventListener('change', (e) => handleFileSelect(e.target.files[0]));
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                imageDropZone.addEventListener(eventName, (e) => { e.preventDefault(); e.stopPropagation(); });
            });
            ['dragenter', 'dragover'].forEach(eventName => {
                imageDropZone.addEventListener(eventName, () => imageDropZone.classList.add('border-main', 'bg-teal-50'));
            });
            ['dragleave', 'drop'].forEach(eventName => {
                imageDropZone.addEventListener(eventName, () => imageDropZone.classList.remove('border-main', 'bg-teal-50'));
            });
            imageDropZone.addEventListener('drop', (e) => handleFileSelect(e.dataTransfer.files[0]));

            steps.upload.querySelector('#next-to-questions-btn').addEventListener('click', () => {
                setupQuestions();
                switchStep('questions');
                switchVisual('imagePreview', imageSrc);
            });
        }
        
        // --- Initial Setup ---
        renderUploadStep('', false);
        switchVisual('initial');
        updateStepperUI();
    });
    </script>
</body>
</html>